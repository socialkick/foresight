<!doctype html>
<html class="no-js" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Foresight - Weather App</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">

</head>
<body>

<div style="border:1px solid #fff; padding:1em; width: 200px; display:block; margin:0 auto;">
    <h1 style="font-size:1.2em; text-transform:uppercase;">Foresight</h1>
    <p>- - - Weather App - - -</p>
</div>
<br>

<input id="locationInput" type="search" placeholder="Enter Location" autofocus />
<p class="errorMessage"></p>
<br><br>

<div id="results">
    <h2 class="locationName"><span style="font-size:0.6em; font-weight:normal;">Loading Last Search...</span></h2>

    <hr><b>Current Conditions</b><hr>
    <!--<p class="timestamp"></p>-->
    <p class="temperature"></p>
    <p class="humidity"></p>
    <p class="windSpeed"></p>
    <br>

    <hr><b>Forecast Summary</b><hr>
    <p class="nextHour"></p>
    <p class="nextDay"></p>
    <p class="nextWeek"></p>
    <br>

    <hr><b>Detailed Forecast</b><hr>
    <p>Day 1</p>
    <p>Day 2</p>
    <p>Day 3</p>
    <p>Day 4</p>
    <p>Day 5</p>
    <p>Day 6</p>
    <p>Day 7</p>
</div>

<script src="js/modernizr-2.8.3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
<script src="js/main.js"></script>


<script>

    // OpenCageData variables - http://geocoder.opencagedata.com/
        var ocdApiUrl = "http://api.opencagedata.com/geocode/v1/json?q=",
            ocdApiKey = "4ace6317360a3946395ae4d807e84cd1",
//            locationInput = null,
            locationData = null,
            locationName = null,
            inputFormatting = function(){
                locationName = locationInput;
                var checkName = function(input){
                    if ( input.city !== undefined ) { locationName = input.city; }
                    else if ( locationData.results[1].components.city !== undefined ) { locationName = locationData.results[1].components.city; }
                    else if ( input.administrative !== undefined ) { locationName = input.administrative }
                    else if ( input.county !== undefined ) { locationName = input.county; }
                    else if ( input.state !== undefined ) { locationName = input.state; }
                    else if ( input.country!== undefined ) { locationName = input.country; }
                    console.log(locationName);
                }; checkName(locationData.results[0].components);
                var locationExtra = '';
                var checkState = function(data){
                    if ( locationName !== data.state && data.state !== undefined ) { locationExtra = ", " + data.state }
                    else if ( locationName == data.state && data.country_code !== undefined ) { locationExtra = ", " + (data.country_code).toUpperCase() }
                }; checkState(locationData.results[0].components);
                locationName = locationName + locationExtra;
            },
            forecastURL = null;


    // Forecast.Io variables - https://developer.forecast.io/
        var fcApiUrl = "https://api.forecast.io/forecast",
            fcApiKey = "2dcaef59f4ef9b896eb1af4ad29d9aa2",
            fcRequestUrl = null,
            weatherData = null;

    // Firebase variables - https://foresightweather.firebaseio.com/
        var fireBase = new Firebase("https://foresightWeather.firebaseio.com/"),
            dataObject = null;

    // Other Global Variables
        var loss = function(failurPoint){
                    showErrorMessage();
                    return (console.log("Failure: " + failurePoint))
                },
            win = function(details){
                hideErrorMessage();
                return (console.log("Success: " + details))
            },
            showResults = function(){ $('#results').css('display','block') },
            hideResults = function(){ $('#results').css('display','none') },
            showErrorMessage = function(){ $('.errorMessage').css('display','block'); },
            hideErrorMessage = function(){ $('.errorMessage').css('display','none') };


    // -------------------- STEPS --------------------

    // Getting location data from OpenCageData
            var getLocationData = function(){
                $.getJSON(ocdRequestUrl, function(data) {
                    locationData = data;
                    fireBase.child("location").set(locationData);
                    inputFormatting();
                    fireBase.child("locationName").set(locationName);
                    var lat = locationData.results[0].geometry.lat,
                            lng = locationData.results[0].geometry.lng;
                    fcRequestUrl = fcApiUrl + "/" + fcApiKey  + "/" + lat + "," + lng + "?callback=?";
                    fireBase.child("forecastRequestURL").set(fcRequestUrl);
                });
            };

    // Retrieving the forecast request URL from Firebase
    var retrieveForecastURL = function(){
        fireBase.on("value", function (snapshot) {
            var lastSnapshot = snapshot.val();
            forecastURL = lastSnapshot.forecastRequestURL;
        }, function (errorObject) {
            console.log("The read failed: " + errorObject.code);
        });
    };

    // Getting the forecast data from Forecast.io
//    var getForecastData = function(url){
//        $.getJSON(url, function(data){
//            weatherData = data;
//            fireBase.child("forecast").set(weatherData);
//        })
//        .success(win("Got JSON weather Data."))
//        .error(loss("getting forecast.io JSON data."))
//    };

    // Populating the forecast data to HTML
    var populateHtml = function() {
        fireBase.on("value", function (snapshot) {
            var lastSnapshot = snapshot.val();
            $('.locationName').text(lastSnapshot.locationName);
            $('.temperature').text("Temperature: " + lastSnapshot.forecast.currently.temperature + "Â°");
            $('.humidity').text("Humidity: " + Math.floor((lastSnapshot.forecast.currently.humidity) * 100) + "%");
            $('.windSpeed').text("Wind Speed: " + lastSnapshot.forecast.currently.windSpeed + "mph");
            $('.nextHour').text("Next Hour: " + lastSnapshot.forecast.minutely.summary);
            $('.nextDay').text("Next 24 Hrs: " + lastSnapshot.forecast.hourly.summary);
            $('.nextWeek').text("Next 7 Days: " + lastSnapshot.forecast.daily.summary);
            hideErrorMessage();
        }, function (errorObject) {
            console.log("The read failed: " + errorObject.code);
        });
    };


    // ------------------- Putting it All Together -------------------

    $(document).ready(function(){
        hideResults();

        var forecastURL = null;
    // Get last search from Firebase
        fireBase.on("value", function (snapshot) {
            var lastSnapshot = snapshot.val();
            forecastURL = lastSnapshot.forecastRequestURL;
            win("Retrieved last query from Firebase.");
        }, function (errorObject) {
            console.log("The read failed: " + errorObject.code);
        });

        console.log(forecastURL);
        if (forecastURL !== null) {
            var getForecastData = function(url){
                $.getJSON(url, function(data){
                    weatherData = data;
                    fireBase.child("forecast").set(weatherData);
                })
                .success(win("Got JSON weather Data."))
                .error(loss("getting forecast.io JSON data."))
            }; getForecastData(forecastURL);
            console.log(weatherData);
        }



    });


</script>


</body>
</html>

















