<!doctype html>
<html class="no-js" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Foresight - Weather App</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <link href='https://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>


</head>
<body>
<div style="border:1px solid #fff; padding:1em; width: 200px; display:block; margin:0 auto;">
    <h1 style="font-size:1.2em; margin-top: 0.2em; text-transform:uppercase;">Foresight</h1>
    <p>- - - Weather App - - -</p>
</div>
<br>

<input id="locationInput" type="search" placeholder="Enter Location" autofocus />
<p class="errorMessage"></p>
<br><br>

<div id="loadingResults">Fetching Forecast...</div>
<div id="results">
    <h2 class="locationName"></h2>

    <div id="currently">
        <h3>Right Now</h3>

        <div class="icon">
            <canvas></canvas>
        </div>
        <div class="temperature">
            <span class="val"></span>
        </div>

        <ul>
            <li class="summary">
                <span class="label">Currently: </span>
                <span class="val"></span>
            </li>
            <li class="apparentTemperature">
                <span class="label">Feels Like: </span>
                <span class="val"></span>
            </li>
            <li class="windSpeed">
                <span class="label">Wind Speed: </span>
                <span class="val"></span>
            </li>
            <li class="visibility">
                <span class="label">Visibility: </span>
                <span class="val"></span>
            </li>
        </ul>
    </div><!--

 --><div id="forecastSummary">
        <h3>Forecast Summary</h3>
        <ul>
            <li class="nextHour">
                <span class="label">Next Hour: </span>
                <span class="val"></span>
            </li>
            <li class="nextDay">
                <span class="label">Next Day: </span>
                <span class="val"></span>
            </li>
            <li class="nextWeek">
                <span class="label">Next Week: </span>
                <span class="val"></span>
            </li>
        </ul>
    </div>


    <div id="next7Days">
        <h3>Next 7 Days</h3>
        <ul>
            <li id="day0">
                <div class="dayOfWeek">loading...</div>
                <canvas class="icon"></canvas>
                <div class="dayDescription"></div>
                <div class="high"></div>
                <div class="low"></div>
            </li>
            <li id="day1">
                <div class="dayOfWeek"></div>
                <canvas class="icon"></canvas>
                <div class="dayDescription"></div>
                <div class="high"></div>
                <div class="low"></div>
            </li>
            <li id="day2">
                <div class="dayOfWeek"></div>
                <canvas class="icon"></canvas>
                <div class="dayDescription"></div>
                <div class="high"></div>
                <div class="low"></div>
            </li>
            <li id="day3">
                <div class="dayOfWeek"></div>
                <canvas class="icon"></canvas>
                <div class="dayDescription"></div>
                <div class="high"></div>
                <div class="low"></div>
            </li>
            <li id="day4">
                <div class="dayOfWeek"></div>
                <canvas class="icon"></canvas>
                <div class="dayDescription"></div>
                <div class="high"></div>
                <div class="low"></div>
            </li>
            <li id="day5">
                <div class="dayOfWeek"></div>
                <canvas class="icon"></canvas>
                <div class="dayDescription"></div>
                <div class="high"></div>
                <div class="low"></div>
            </li>
            <li id="day6">
                <div class="dayOfWeek"></div>
                <canvas class="icon"></canvas>
                <div class="dayDescription"></div>
                <div class="high"></div>
                <div class="low"></div>
            </li>
        </ul>
    </div>

</div>


<script src="js/modernizr-2.8.3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
<script src="js/skycons.js"></script>
<script src="js/main.js"></script>


<script>
// OpenCageData variables - http://geocoder.opencagedata.com/ --------------------
    var ocdApiKey = "4ace6317360a3946395ae4d807e84cd1",
        ocdApiUrl = "http://api.opencagedata.com/geocode/v1/json?q=",
        ocdRequestUrl = null,
        locationData = null,
        locationName = null,
        locationInput = null,
        inputFormatting = function(){
            var checkName = function(input){
                if ( input.city !== undefined ) { locationName = input.city; }
                else if ( locationData.results[1].components.city !== undefined ) { locationName = locationData.results[1].components.city; }
                else if ( input.administrative !== undefined ) { locationName = input.administrative }
                else if ( input.county !== undefined ) { locationName = input.county; }
                else if ( input.state !== undefined ) { locationName = input.state; }
                else if ( input.country!== undefined ) { locationName = input.country; }
                console.log(locationName);
            }; checkName(locationData.results[0].components);
            var locationExtra = '';
            var checkState = function(data){
                if ( locationName !== data.state && data.state !== undefined ) { locationExtra = ", " + data.state }
                else if ( locationName == data.state && data.country_code !== undefined ) { locationExtra = ", " + (data.country_code).toUpperCase() }
            }; checkState(locationData.results[0].components);
            locationName = locationName + locationExtra;
        };

// Forecast.Io variables - https://developer.forecast.io/ --------------------
    var fcApiUrl = "https://api.forecast.io/forecast",
        fcApiKey = "2dcaef59f4ef9b896eb1af4ad29d9aa2",
        fcRequestUrl = null,
        weatherData = null;

// Firebase variables - https://foresightweather.firebaseio.com/ --------------------
    var fireBase = new Firebase("https://foresightWeather.firebaseio.com/"),
        dataObject = null;

// Time Variables --------------------
    var date = new Date(),
        today = date.getDay(),
        dayNames = ['sun','mon','tue','wed','thu','fri','sat'];
for (var i=0; i<7; i++) {
    var ID = "#day"+i+" .dayOfWeek",
            dayNumber = today+i;
    if (dayNumber > 6) { dayNumber -=7 }
    $(ID).text(dayNames[dayNumber] + ': ');
}
$('#day0 .dayOfWeek').text('today: ');

// Skycons --------------------
    var renderSkycons = function(){
        var icons = new Skycons({"color": "#fff"}),
                list  = [
                    "clear-day", "clear-night", "partly-cloudy-day",
                    "partly-cloudy-night", "cloudy", "rain", "sleet", "snow", "wind",
                    "fog" ];
        for(var i = list.length; i--; )
            icons.set(list[i], list[i]);
        icons.play();
        for(i = list.length; i--; ) {
            var weatherType = list[i],
                    elements = document.getElementsByClassName( weatherType );
            for (e = elements.length; e--;){
                icons.set( elements[e], weatherType );
            }
        }
    };


// Populating the HTML --------------------
    var populateHtml = function(input) {

    // Current Conditions ----------
        $('#currently .icon canvas').removeClass().addClass(input.currently.icon);
        $('#currently .temperature .val').text(Math.floor(input.currently.temperature) + "째");
        $('#currently .summary .val').text(input.currently.summary);
        $('#currently .apparentTemperature .val').text(Math.round(input.currently.apparentTemperature) + "째");

        $('#currently .humidity .val').text(Math.floor((input.currently.humidity) * 100) + "%");
        $('#currently .windSpeed .val').text(Math.round(input.currently.windSpeed) + " mph");
        $('#currently .visibility .val').text(Math.round(input.currently.visibility) + " mi");

        $('#forecastSummary .nextHour .val').text(input.minutely.summary);
        $('#forecastSummary .nextDay .val').text(input.hourly.summary);
        $('#forecastSummary .nextWeek .val').text(input.daily.summary);

    // Daily Summary ----------
        for (var i=0; i<7; i++) {
            var ID = "#day"+i+" .dayDescription";
            $(ID).text(input.daily.data[i].summary);
        }

    // Daily Highs and Lows ----------
        for (var i=0; i<7; i++) {
            var ID = "#day"+i+" .high";
            $(ID).text(Math.round(input.daily.data[i].temperatureMax) + "째");
            var ID = "#day"+i+" .low";
            $(ID).text(Math.round(input.daily.data[i].temperatureMin) + "째");
        }

    // Daily Icon ----------
        for (var i=0; i<7; i++) {
            var ID = "#day"+i+" canvas";
            $(ID).removeClass().addClass(input.daily.data[i].icon);
        }
        renderSkycons();
    };

// Other Global Variables -------------------
    var fail = function(failurePoint){ return (console.log("Failure: " + failurePoint)) },
        win = function(){ return (console.log("Success!")) },
        showResults = function(){ $('#results').show();
                                  $('#loadingResults').hide()},
        hideResults = function(){ $('#results').hide();
                                  $('#loadingResults').show()};


// Putting Everything together -------------------
    $(document).ready(function(){
        $('#locationInput').keyup(function(e) {
            locationInput = $('#locationInput').val().toLowerCase();
            if (e.keyCode == 13) {
                hideResults();
                ocdRequestUrl = ocdApiUrl + locationInput + "&key=" + ocdApiKey;
                $.getJSON(ocdRequestUrl, function(data) {
                    locationData = data;
                    inputFormatting();
                    var lat = locationData.results[0].geometry.lat,
                        lng = locationData.results[0].geometry.lng;
                    fcRequestUrl = fcApiUrl + "/" + fcApiKey  + "/" + lat + "," + lng + "?callback=?";
                    $.getJSON(fcRequestUrl, function(data){
                        weatherData = data;
                        populateHtml(weatherData);
                        showResults();
                    })
                    .success(function(){ win("Fetched and Populated the Forecast."); })
                    .error(function(){ fail("getting forecast.io JSON data."); });
                }).error(function(){ fail("getting location JSON data."); });
                $('#locationInput').val('');
            }
        });
    });


</script>


</body>
</html>